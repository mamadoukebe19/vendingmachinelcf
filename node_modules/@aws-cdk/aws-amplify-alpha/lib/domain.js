"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.Domain = void 0;
const jsiiDeprecationWarnings = require("../.warnings.jsii.js");
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
const core_1 = require("aws-cdk-lib/core");
const aws_amplify_1 = require("aws-cdk-lib/aws-amplify");
const metadata_resource_1 = require("aws-cdk-lib/core/lib/metadata-resource");
/**
 * An Amplify Console domain
 */
class Domain extends core_1.Resource {
    constructor(scope, id, props) {
        super(scope, id);
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_amplify_alpha_DomainProps(props);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, Domain);
            }
            throw error;
        }
        // Enhanced CDK Analytics Telemetry
        (0, metadata_resource_1.addConstructMetadata)(this, props);
        this.subDomains = props.subDomains || [];
        const domainName = props.domainName || id;
        if (!core_1.Token.isUnresolved(domainName) && domainName.length > 255) {
            throw new core_1.ValidationError(`Domain name must be 255 characters or less, got: ${domainName.length} characters.`, this);
        }
        if (!core_1.Token.isUnresolved(domainName) && !/^(((?!-)[A-Za-z0-9-]{0,62}[A-Za-z0-9])\.)+((?!-)[A-Za-z0-9-]{1,62}[A-Za-z0-9])(\.)?$/.test(domainName)) {
            throw new core_1.ValidationError(`Domain name must be a valid hostname, got: ${domainName}.`, this);
        }
        const domain = new aws_amplify_1.CfnDomain(this, 'Resource', {
            appId: props.app.appId,
            domainName,
            subDomainSettings: core_1.Lazy.any({ produce: () => this.renderSubDomainSettings() }, { omitEmptyArray: true }),
            enableAutoSubDomain: !!props.enableAutoSubdomain,
            autoSubDomainCreationPatterns: props.autoSubdomainCreationPatterns || ['*', 'pr*'],
            autoSubDomainIamRole: props.autoSubDomainIamRole?.roleArn,
            certificateSettings: props.customCertificate ? {
                certificateType: 'CUSTOM',
                customCertificateArn: props.customCertificate.certificateArn,
            } : undefined,
        });
        this.arn = domain.attrArn;
        this.certificateRecord = domain.attrCertificateRecord;
        this.domainName = domain.attrDomainName;
        this.domainStatus = domain.attrDomainStatus;
        this.statusReason = domain.attrStatusReason;
        this.domainAutoSubDomainCreationPatterns = domain.attrAutoSubDomainCreationPatterns;
        this.domainAutoSubDomainIamRole = domain.attrAutoSubDomainIamRole;
        this.domainEnableAutoSubDomain = domain.attrEnableAutoSubDomain;
        this.node.addValidation({ validate: () => this.validateDomain() });
    }
    /**
     * Maps a branch to a sub domain
     *
     * @param branch The branch
     * @param prefix The prefix. Use '' to map to the root of the domain. Defaults to branch name.
     */
    mapSubDomain(branch, prefix) {
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_amplify_alpha_IBranch(branch);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.mapSubDomain);
            }
            throw error;
        }
        this.subDomains.push({ branch, prefix });
        return this;
    }
    /**
     * Maps a branch to the domain root
     */
    mapRoot(branch) {
        try {
            jsiiDeprecationWarnings._aws_cdk_aws_amplify_alpha_IBranch(branch);
        }
        catch (error) {
            if (process.env.JSII_DEBUG !== "1" && error.name === "DeprecationError") {
                Error.captureStackTrace(error, this.mapRoot);
            }
            throw error;
        }
        return this.mapSubDomain(branch, '');
    }
    validateDomain() {
        if (this.subDomains.length === 0) {
            return ['The domain doesn\'t contain any subdomains'];
        }
        return [];
    }
    renderSubDomainSettings() {
        return this.subDomains.map(s => ({
            branchName: s.branch.branchName,
            prefix: s.prefix ?? s.branch.branchName,
        }));
    }
}
exports.Domain = Domain;
_a = JSII_RTTI_SYMBOL_1;
Domain[_a] = { fqn: "@aws-cdk/aws-amplify-alpha.Domain", version: "2.179.0-alpha.0" };
__decorate([
    (0, metadata_resource_1.MethodMetadata)()
], Domain.prototype, "mapSubDomain", null);
__decorate([
    (0, metadata_resource_1.MethodMetadata)()
], Domain.prototype, "mapRoot", null);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9tYWluLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZG9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUVBLDJDQUF1RjtBQUV2Rix5REFBb0Q7QUFHcEQsOEVBQThGO0FBMEQ5Rjs7R0FFRztBQUNILE1BQWEsTUFBTyxTQUFRLGVBQVE7SUEyRGxDLFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBa0I7UUFDMUQsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQzs7Ozs7OytDQTVEUixNQUFNOzs7O1FBNkRmLG1DQUFtQztRQUNuQyxJQUFBLHdDQUFvQixFQUFDLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztRQUVsQyxJQUFJLENBQUMsVUFBVSxHQUFHLEtBQUssQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDO1FBRXpDLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDO1FBQzFDLElBQUksQ0FBQyxZQUFLLENBQUMsWUFBWSxDQUFDLFVBQVUsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUM7WUFDL0QsTUFBTSxJQUFJLHNCQUFlLENBQUMsb0RBQW9ELFVBQVUsQ0FBQyxNQUFNLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN2SCxDQUFDO1FBQ0QsSUFBSSxDQUFDLFlBQUssQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxzRkFBc0YsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztZQUNoSixNQUFNLElBQUksc0JBQWUsQ0FBQyw4Q0FBOEMsVUFBVSxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDL0YsQ0FBQztRQUVELE1BQU0sTUFBTSxHQUFHLElBQUksdUJBQVMsQ0FBQyxJQUFJLEVBQUUsVUFBVSxFQUFFO1lBQzdDLEtBQUssRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLEtBQUs7WUFDdEIsVUFBVTtZQUNWLGlCQUFpQixFQUFFLFdBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLHVCQUF1QixFQUFFLEVBQUUsRUFBRSxFQUFFLGNBQWMsRUFBRSxJQUFJLEVBQUUsQ0FBQztZQUN4RyxtQkFBbUIsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLG1CQUFtQjtZQUNoRCw2QkFBNkIsRUFBRSxLQUFLLENBQUMsNkJBQTZCLElBQUksQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDO1lBQ2xGLG9CQUFvQixFQUFFLEtBQUssQ0FBQyxvQkFBb0IsRUFBRSxPQUFPO1lBQ3pELG1CQUFtQixFQUFFLEtBQUssQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7Z0JBQzdDLGVBQWUsRUFBRSxRQUFRO2dCQUN6QixvQkFBb0IsRUFBRSxLQUFLLENBQUMsaUJBQWlCLENBQUMsY0FBYzthQUM3RCxDQUFDLENBQUMsQ0FBQyxTQUFTO1NBQ2QsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDO1FBQzFCLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxNQUFNLENBQUMscUJBQXFCLENBQUM7UUFDdEQsSUFBSSxDQUFDLFVBQVUsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1FBQzVDLElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1FBQzVDLElBQUksQ0FBQyxtQ0FBbUMsR0FBRyxNQUFNLENBQUMsaUNBQWlDLENBQUM7UUFDcEYsSUFBSSxDQUFDLDBCQUEwQixHQUFHLE1BQU0sQ0FBQyx3QkFBd0IsQ0FBQztRQUNsRSxJQUFJLENBQUMseUJBQXlCLEdBQUcsTUFBTSxDQUFDLHVCQUF1QixDQUFDO1FBRWhFLElBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsUUFBUSxFQUFFLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRSxDQUFDLENBQUM7S0FDcEU7SUFFRDs7Ozs7T0FLRztJQUVJLFlBQVksQ0FBQyxNQUFlLEVBQUUsTUFBZTs7Ozs7Ozs7OztRQUNsRCxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ3pDLE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFFRDs7T0FFRztJQUVJLE9BQU8sQ0FBQyxNQUFlOzs7Ozs7Ozs7O1FBQzVCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7S0FDdEM7SUFFTyxjQUFjO1FBQ3BCLElBQUksSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDakMsT0FBTyxDQUFDLDRDQUE0QyxDQUFDLENBQUM7UUFDeEQsQ0FBQztRQUVELE9BQU8sRUFBRSxDQUFDO0tBQ1g7SUFFTyx1QkFBdUI7UUFDN0IsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDL0IsVUFBVSxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsVUFBVTtZQUMvQixNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLFVBQVU7U0FDeEMsQ0FBQyxDQUFDLENBQUM7S0FDTDs7QUFwSUgsd0JBcUlDOzs7QUEzQlE7SUFETixJQUFBLGtDQUFjLEdBQUU7MENBSWhCO0FBTU07SUFETixJQUFBLGtDQUFjLEdBQUU7cUNBR2hCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYWNtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1jZXJ0aWZpY2F0ZW1hbmFnZXInO1xuaW1wb3J0ICogYXMgaWFtIGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHsgTGF6eSwgUmVzb3VyY2UsIElSZXNvbHZhYmxlLCBUb2tlbiwgVmFsaWRhdGlvbkVycm9yIH0gZnJvbSAnYXdzLWNkay1saWIvY29yZSc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcbmltcG9ydCB7IENmbkRvbWFpbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1hbXBsaWZ5JztcbmltcG9ydCB7IElBcHAgfSBmcm9tICcuL2FwcCc7XG5pbXBvcnQgeyBJQnJhbmNoIH0gZnJvbSAnLi9icmFuY2gnO1xuaW1wb3J0IHsgYWRkQ29uc3RydWN0TWV0YWRhdGEsIE1ldGhvZE1ldGFkYXRhIH0gZnJvbSAnYXdzLWNkay1saWIvY29yZS9saWIvbWV0YWRhdGEtcmVzb3VyY2UnO1xuXG4vKipcbiAqIE9wdGlvbnMgdG8gYWRkIGEgZG9tYWluIHRvIGFuIGFwcGxpY2F0aW9uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRG9tYWluT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgZG9tYWluXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gdGhlIGNvbnN0cnVjdCdzIGlkXG4gICAqL1xuICByZWFkb25seSBkb21haW5OYW1lPzogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBTdWJkb21haW5zXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gdXNlIGBhZGRTdWJEb21haW4oKWAgdG8gYWRkIHN1YmRvbWFpbnNcbiAgICovXG4gIHJlYWRvbmx5IHN1YkRvbWFpbnM/OiBTdWJEb21haW5bXTtcblxuICAvKipcbiAgICogQXV0b21hdGljYWxseSBjcmVhdGUgc3ViZG9tYWlucyBmb3IgY29ubmVjdGVkIGJyYW5jaGVzXG4gICAqXG4gICAqIEBkZWZhdWx0IGZhbHNlXG4gICAqL1xuICByZWFkb25seSBlbmFibGVBdXRvU3ViZG9tYWluPzogYm9vbGVhbjtcblxuICAvKipcbiAgICogQnJhbmNoZXMgd2hpY2ggc2hvdWxkIGF1dG9tYXRpY2FsbHkgY3JlYXRlIHN1YmRvbWFpbnNcbiAgICpcbiAgICogQGRlZmF1bHQgLSBhbGwgcmVwb3NpdG9yeSBicmFuY2hlcyBbJyonLCAncHIqJ11cbiAgICovXG4gIHJlYWRvbmx5IGF1dG9TdWJkb21haW5DcmVhdGlvblBhdHRlcm5zPzogc3RyaW5nW107XG5cbiAgLyoqXG4gICAqIFRoZSB0eXBlIG9mIFNTTC9UTFMgY2VydGlmaWNhdGUgdG8gdXNlIGZvciB5b3VyIGN1c3RvbSBkb21haW5cbiAgICpcbiAgICogQGRlZmF1bHQgLSBBbXBsaWZ5IHVzZXMgdGhlIGRlZmF1bHQgY2VydGlmaWNhdGUgdGhhdCBpdCBwcm92aXNpb25zIGFuZCBtYW5hZ2VzIGZvciB5b3VcbiAgICovXG4gIHJlYWRvbmx5IGN1c3RvbUNlcnRpZmljYXRlPzogYWNtLklDZXJ0aWZpY2F0ZTtcbn1cblxuLyoqXG4gKiBQcm9wZXJ0aWVzIGZvciBhIERvbWFpblxuICovXG5leHBvcnQgaW50ZXJmYWNlIERvbWFpblByb3BzIGV4dGVuZHMgRG9tYWluT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBUaGUgYXBwbGljYXRpb24gdG8gd2hpY2ggdGhlIGRvbWFpbiBtdXN0IGJlIGNvbm5lY3RlZFxuICAgKi9cbiAgcmVhZG9ubHkgYXBwOiBJQXBwO1xuXG4gIC8qKlxuICAgKiBUaGUgSUFNIHJvbGUgd2l0aCBhY2Nlc3MgdG8gUm91dGU1MyB3aGVuIHVzaW5nIGVuYWJsZUF1dG9TdWJkb21haW5cbiAgICogQGRlZmF1bHQgdGhlIElBTSByb2xlIGZyb20gQXBwLmdyYW50UHJpbmNpcGFsXG4gICAqL1xuICByZWFkb25seSBhdXRvU3ViRG9tYWluSWFtUm9sZT86IGlhbS5JUm9sZTtcbn1cblxuLyoqXG4gKiBBbiBBbXBsaWZ5IENvbnNvbGUgZG9tYWluXG4gKi9cbmV4cG9ydCBjbGFzcyBEb21haW4gZXh0ZW5kcyBSZXNvdXJjZSB7XG4gIC8qKlxuICAgKiBUaGUgQVJOIG9mIHRoZSBkb21haW5cbiAgICpcbiAgICogQGF0dHJpYnV0ZVxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGFybjogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgRE5TIFJlY29yZCBmb3IgY2VydGlmaWNhdGUgdmVyaWZpY2F0aW9uXG4gICAqXG4gICAqIEBhdHRyaWJ1dGVcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBjZXJ0aWZpY2F0ZVJlY29yZDogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBUaGUgbmFtZSBvZiB0aGUgZG9tYWluXG4gICAqXG4gICAqIEBhdHRyaWJ1dGVcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBkb21haW5OYW1lOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSBzdGF0dXMgb2YgdGhlIGRvbWFpbiBhc3NvY2lhdGlvblxuICAgKlxuICAgKiBAYXR0cmlidXRlXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgZG9tYWluU3RhdHVzOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIFRoZSByZWFzb24gZm9yIHRoZSBjdXJyZW50IHN0YXR1cyBvZiB0aGUgZG9tYWluXG4gICAqXG4gICAqIEBhdHRyaWJ1dGVcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBzdGF0dXNSZWFzb246IHN0cmluZztcblxuICAvKipcbiAgICogQnJhbmNoIHBhdHRlcm5zIGZvciB0aGUgYXV0b21hdGljYWxseSBjcmVhdGVkIHN1YmRvbWFpbi5cbiAgICpcbiAgICogQGF0dHJpYnV0ZVxuICAgKi9cbiAgcHVibGljIHJlYWRvbmx5IGRvbWFpbkF1dG9TdWJEb21haW5DcmVhdGlvblBhdHRlcm5zOiBzdHJpbmdbXTtcblxuICAvKipcbiAgICogVGhlIElBTSBzZXJ2aWNlIHJvbGUgZm9yIHRoZSBzdWJkb21haW4uXG4gICAqXG4gICAqIEBhdHRyaWJ1dGVcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBkb21haW5BdXRvU3ViRG9tYWluSWFtUm9sZTogc3RyaW5nO1xuXG4gIC8qKlxuICAgKiBTcGVjaWZpZXMgd2hldGhlciB0aGUgYXV0b21hdGVkIGNyZWF0aW9uIG9mIHN1YmRvbWFpbnMgZm9yIGJyYW5jaGVzIGlzIGVuYWJsZWQuXG4gICAqXG4gICAqIEBhdHRyaWJ1dGVcbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBkb21haW5FbmFibGVBdXRvU3ViRG9tYWluOiBJUmVzb2x2YWJsZTtcblxuICBwcml2YXRlIHJlYWRvbmx5IHN1YkRvbWFpbnM6IFN1YkRvbWFpbltdO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBDb25zdHJ1Y3QsIGlkOiBzdHJpbmcsIHByb3BzOiBEb21haW5Qcm9wcykge1xuICAgIHN1cGVyKHNjb3BlLCBpZCk7XG4gICAgLy8gRW5oYW5jZWQgQ0RLIEFuYWx5dGljcyBUZWxlbWV0cnlcbiAgICBhZGRDb25zdHJ1Y3RNZXRhZGF0YSh0aGlzLCBwcm9wcyk7XG5cbiAgICB0aGlzLnN1YkRvbWFpbnMgPSBwcm9wcy5zdWJEb21haW5zIHx8IFtdO1xuXG4gICAgY29uc3QgZG9tYWluTmFtZSA9IHByb3BzLmRvbWFpbk5hbWUgfHwgaWQ7XG4gICAgaWYgKCFUb2tlbi5pc1VucmVzb2x2ZWQoZG9tYWluTmFtZSkgJiYgZG9tYWluTmFtZS5sZW5ndGggPiAyNTUpIHtcbiAgICAgIHRocm93IG5ldyBWYWxpZGF0aW9uRXJyb3IoYERvbWFpbiBuYW1lIG11c3QgYmUgMjU1IGNoYXJhY3RlcnMgb3IgbGVzcywgZ290OiAke2RvbWFpbk5hbWUubGVuZ3RofSBjaGFyYWN0ZXJzLmAsIHRoaXMpO1xuICAgIH1cbiAgICBpZiAoIVRva2VuLmlzVW5yZXNvbHZlZChkb21haW5OYW1lKSAmJiAhL14oKCg/IS0pW0EtWmEtejAtOS1dezAsNjJ9W0EtWmEtejAtOV0pXFwuKSsoKD8hLSlbQS1aYS16MC05LV17MSw2Mn1bQS1aYS16MC05XSkoXFwuKT8kLy50ZXN0KGRvbWFpbk5hbWUpKSB7XG4gICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKGBEb21haW4gbmFtZSBtdXN0IGJlIGEgdmFsaWQgaG9zdG5hbWUsIGdvdDogJHtkb21haW5OYW1lfS5gLCB0aGlzKTtcbiAgICB9XG5cbiAgICBjb25zdCBkb21haW4gPSBuZXcgQ2ZuRG9tYWluKHRoaXMsICdSZXNvdXJjZScsIHtcbiAgICAgIGFwcElkOiBwcm9wcy5hcHAuYXBwSWQsXG4gICAgICBkb21haW5OYW1lLFxuICAgICAgc3ViRG9tYWluU2V0dGluZ3M6IExhenkuYW55KHsgcHJvZHVjZTogKCkgPT4gdGhpcy5yZW5kZXJTdWJEb21haW5TZXR0aW5ncygpIH0sIHsgb21pdEVtcHR5QXJyYXk6IHRydWUgfSksXG4gICAgICBlbmFibGVBdXRvU3ViRG9tYWluOiAhIXByb3BzLmVuYWJsZUF1dG9TdWJkb21haW4sXG4gICAgICBhdXRvU3ViRG9tYWluQ3JlYXRpb25QYXR0ZXJuczogcHJvcHMuYXV0b1N1YmRvbWFpbkNyZWF0aW9uUGF0dGVybnMgfHwgWycqJywgJ3ByKiddLFxuICAgICAgYXV0b1N1YkRvbWFpbklhbVJvbGU6IHByb3BzLmF1dG9TdWJEb21haW5JYW1Sb2xlPy5yb2xlQXJuLFxuICAgICAgY2VydGlmaWNhdGVTZXR0aW5nczogcHJvcHMuY3VzdG9tQ2VydGlmaWNhdGUgPyB7XG4gICAgICAgIGNlcnRpZmljYXRlVHlwZTogJ0NVU1RPTScsXG4gICAgICAgIGN1c3RvbUNlcnRpZmljYXRlQXJuOiBwcm9wcy5jdXN0b21DZXJ0aWZpY2F0ZS5jZXJ0aWZpY2F0ZUFybixcbiAgICAgIH0gOiB1bmRlZmluZWQsXG4gICAgfSk7XG5cbiAgICB0aGlzLmFybiA9IGRvbWFpbi5hdHRyQXJuO1xuICAgIHRoaXMuY2VydGlmaWNhdGVSZWNvcmQgPSBkb21haW4uYXR0ckNlcnRpZmljYXRlUmVjb3JkO1xuICAgIHRoaXMuZG9tYWluTmFtZSA9IGRvbWFpbi5hdHRyRG9tYWluTmFtZTtcbiAgICB0aGlzLmRvbWFpblN0YXR1cyA9IGRvbWFpbi5hdHRyRG9tYWluU3RhdHVzO1xuICAgIHRoaXMuc3RhdHVzUmVhc29uID0gZG9tYWluLmF0dHJTdGF0dXNSZWFzb247XG4gICAgdGhpcy5kb21haW5BdXRvU3ViRG9tYWluQ3JlYXRpb25QYXR0ZXJucyA9IGRvbWFpbi5hdHRyQXV0b1N1YkRvbWFpbkNyZWF0aW9uUGF0dGVybnM7XG4gICAgdGhpcy5kb21haW5BdXRvU3ViRG9tYWluSWFtUm9sZSA9IGRvbWFpbi5hdHRyQXV0b1N1YkRvbWFpbklhbVJvbGU7XG4gICAgdGhpcy5kb21haW5FbmFibGVBdXRvU3ViRG9tYWluID0gZG9tYWluLmF0dHJFbmFibGVBdXRvU3ViRG9tYWluO1xuXG4gICAgdGhpcy5ub2RlLmFkZFZhbGlkYXRpb24oeyB2YWxpZGF0ZTogKCkgPT4gdGhpcy52YWxpZGF0ZURvbWFpbigpIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIE1hcHMgYSBicmFuY2ggdG8gYSBzdWIgZG9tYWluXG4gICAqXG4gICAqIEBwYXJhbSBicmFuY2ggVGhlIGJyYW5jaFxuICAgKiBAcGFyYW0gcHJlZml4IFRoZSBwcmVmaXguIFVzZSAnJyB0byBtYXAgdG8gdGhlIHJvb3Qgb2YgdGhlIGRvbWFpbi4gRGVmYXVsdHMgdG8gYnJhbmNoIG5hbWUuXG4gICAqL1xuICBATWV0aG9kTWV0YWRhdGEoKVxuICBwdWJsaWMgbWFwU3ViRG9tYWluKGJyYW5jaDogSUJyYW5jaCwgcHJlZml4Pzogc3RyaW5nKSB7XG4gICAgdGhpcy5zdWJEb21haW5zLnB1c2goeyBicmFuY2gsIHByZWZpeCB9KTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBNYXBzIGEgYnJhbmNoIHRvIHRoZSBkb21haW4gcm9vdFxuICAgKi9cbiAgQE1ldGhvZE1ldGFkYXRhKClcbiAgcHVibGljIG1hcFJvb3QoYnJhbmNoOiBJQnJhbmNoKSB7XG4gICAgcmV0dXJuIHRoaXMubWFwU3ViRG9tYWluKGJyYW5jaCwgJycpO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZURvbWFpbigpIHtcbiAgICBpZiAodGhpcy5zdWJEb21haW5zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFsnVGhlIGRvbWFpbiBkb2VzblxcJ3QgY29udGFpbiBhbnkgc3ViZG9tYWlucyddO1xuICAgIH1cblxuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHByaXZhdGUgcmVuZGVyU3ViRG9tYWluU2V0dGluZ3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3ViRG9tYWlucy5tYXAocyA9PiAoe1xuICAgICAgYnJhbmNoTmFtZTogcy5icmFuY2guYnJhbmNoTmFtZSxcbiAgICAgIHByZWZpeDogcy5wcmVmaXggPz8gcy5icmFuY2guYnJhbmNoTmFtZSxcbiAgICB9KSk7XG4gIH1cbn1cblxuLyoqXG4gKiBTdWIgZG9tYWluIHNldHRpbmdzXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU3ViRG9tYWluIHtcbiAgLyoqXG4gICAqIFRoZSBicmFuY2hcbiAgICovXG4gIHJlYWRvbmx5IGJyYW5jaDogSUJyYW5jaDtcblxuICAvKipcbiAgICogVGhlIHByZWZpeC4gVXNlICcnIHRvIG1hcCB0byB0aGUgcm9vdCBvZiB0aGUgZG9tYWluXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gdGhlIGJyYW5jaCBuYW1lXG4gICAqL1xuICByZWFkb25seSBwcmVmaXg/OiBzdHJpbmc7XG59XG4iXX0=